{{ 'priceelephant-dashboard.css' | asset_url | stylesheet_tag }}

{% if customer %}
  <div
    class="pe-dashboard"
    id="priceelephant-dashboard-root"
    data-api-base-url="{{ section.settings.api_base_url | escape }}"
    data-customer-id="{{ customer.id }}"
  >
    <!-- DEBUG PANEL - Theme ID: 155038613720 -->
    <div class="pe-card" style="background: #f0f9ff; border-left: 4px solid #0284c7;">
      <h3 style="margin-top: 0; color: #0284c7;">üîß Debug Info (Auto-Deploy Active)</h3>
      <div id="pe-debug-output" style="font-family: monospace; font-size: 12px; line-height: 1.6;">
        <div><strong>Customer ID:</strong> {{ customer.id }}</div>
        <div><strong>API Base URL:</strong> <span id="pe-debug-url">{{ section.settings.api_base_url | escape }}</span></div>
        <div><strong>Script Status:</strong> <span id="pe-debug-script">‚è≥ Wachten...</span></div>
        <div><strong>Event Listeners:</strong> <span id="pe-debug-listeners">‚è≥ Wachten...</span></div>
        <div><strong>Last Action:</strong> <span id="pe-debug-action">-</span></div>
        <div><strong>Last Error:</strong> <span id="pe-debug-error" style="color: #dc2626;">-</span></div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #cbd5e1;">
          <strong>API Tests:</strong><br>
          <span id="pe-debug-channable" style="color: #64748b;">Channable: ‚è≥</span><br>
          <span id="pe-debug-sitemap" style="color: #64748b;">Sitemap: ‚è≥</span><br>
          <span id="pe-debug-products" style="color: #64748b;">Products: ‚è≥</span>
        </div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #cbd5e1;">
          <strong>Sitemap errors (<span id="pe-debug-error-count">0</span>):</strong>
          <div id="pe-debug-error-list" style="max-height: 160px; overflow-y: auto; background: #e2e8f0; border-radius: 6px; padding: 6px; margin-top: 4px;"></div>
        </div>
      </div>
    </div>
    
    <!-- Product Import Options -->
    <div style="max-width: 800px; margin: 0 auto 24px;">
      <h2 style="margin-bottom: 8px;">Product import methode</h2>
      <p style="color: #64748b; margin-bottom: 16px;">Kies √©√©n van de volgende opties om producten te importeren:</p>
    </div>
    
    <div class="pe-dashboard__grid">
      <section class="pe-card" id="pe-channable-card">
        <h2>Optie 1: Channable integratie</h2>
        <p>Heb je al een Channable feed? Gebruik deze optie.</p>
        <div id="pe-channable-status" class="pe-alert" hidden></div>
        <form id="pe-channable-form" novalidate>
          <div class="pe-field">
            <label for="pe-feed-url">Feed URL (XML/CSV)</label>
            <input type="url" id="pe-feed-url" name="feedUrl" placeholder="https://example.com/channable-feed.xml">
          </div>
          <div class="pe-field-group">
            <div class="pe-field">
              <label for="pe-company-id">Company ID</label>
              <input type="text" id="pe-company-id" name="companyId" placeholder="12345">
            </div>
            <div class="pe-field">
              <label for="pe-project-id">Project ID</label>
              <input type="text" id="pe-project-id" name="projectId" placeholder="67890">
            </div>
            <div class="pe-field">
              <label for="pe-api-token">API token</label>
              <input type="password" id="pe-api-token" name="apiToken" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
          </div>
          <div class="pe-field">
            <label for="pe-feed-format">Feed formaat</label>
            <select id="pe-feed-format" name="feedFormat">
              <option value="xml" selected>XML (Google Shopping)</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          <div class="pe-card__footer">
            <button type="submit" class="pe-button pe-button--primary" id="pe-channable-save">Instellingen opslaan</button>
            <button type="button" class="pe-button pe-button--secondary" id="pe-channable-import">Nu importeren</button>
          </div>
        </form>
      </section>

      <section class="pe-card" id="pe-sitemap-card">
        <h2>Optie 2: Sitemap import</h2>
        <p>Geen Channable? Gebruik je webshop sitemap.xml.</p>
        <p><small class="pe-text-muted">‚ú® Intelligente detectie: scant automatisch alle URLs en herkent productpagina's op basis van prijs en titel.</small></p>
        
        <!-- Progress bar -->
        <div id="pe-sitemap-progress" class="pe-progress-container" hidden>
          <div class="pe-progress-bar">
            <div id="pe-sitemap-progress-fill" class="pe-progress-fill" style="width: 0%"></div>
          </div>
          <div id="pe-sitemap-progress-text" class="pe-progress-text">Voorbereiden...</div>
        </div>
        
        <div id="pe-sitemap-status" class="pe-alert" hidden></div>
        <form id="pe-sitemap-form" novalidate>
          <div class="pe-field">
            <label for="pe-sitemap-url">Sitemap URL</label>
            <input type="url" id="pe-sitemap-url" name="sitemapUrl" placeholder="https://jouwwebshop.nl/sitemap.xml">
          </div>
          <div class="pe-field-group">
            <div class="pe-field">
              <label for="pe-max-products">Max producten</label>
              <input type="number" id="pe-max-products" name="maxProducts" min="1" max="10000" value="500">
              <small class="pe-text-muted" id="pe-max-products-hint">Standaard: 500 producten</small>
            </div>
            <div class="pe-field">
              <label for="pe-url-pattern">URL filter (optioneel)</label>
              <input type="text" id="pe-url-pattern" name="productUrlPattern" placeholder="/product/">
              <small class="pe-text-muted">Optioneel: pre-filter URLs voordat intelligent scannen start (versnelt proces)</small>
            </div>
            <div class="pe-field">
              <label>
                <input type="checkbox" id="pe-background-mode" name="backgroundMode">
                Achtergrond modus (sluiten toegestaan)
              </label>
              <small class="pe-text-muted">‚ú® Aangevinkt: import draait op achtergrond, je kunt browser sluiten. Uitgevinkt: live voortgang, blijf op pagina.</small>
            </div>
            <div id="pe-resume-status" style="display: none; padding: 12px; background: #f0f9ff; border-left: 3px solid #3b82f6; margin-bottom: 12px; border-radius: 4px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: 18px;">‚ñ∂Ô∏è</span>
                <strong style="color: #1e40af;">Voortgang opgeslagen</strong>
              </div>
              <div style="font-size: 14px; color: #475569;">
                Laatst gestopt bij: <strong id="pe-resume-position">URL #0</strong>
              </div>
              <small style="color: #64748b; display: block; margin-top: 4px;">
                üí° Laat de checkbox hieronder <u>uitgevinkt</u> om verder te gaan waar je gestopt bent.
              </small>
            </div>
            <div id="pe-background-status" style="display: none; padding: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; margin-bottom: 12px; border-radius: 4px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: 18px;">‚öôÔ∏è</span>
                <strong style="color: #92400e;">Import draait op achtergrond</strong>
              </div>
              <div style="font-size: 14px; color: #475569;">
                Status: <strong id="pe-bg-status-text">Bezig...</strong> | 
                Voortgang: <strong id="pe-bg-progress">0%</strong> | 
                Gescand: <strong id="pe-bg-scanned">0</strong>
              </div>
              <small style="color: #64748b; display: block; margin-top: 4px;">
                üîÑ Deze pagina vernieuwt automatisch elke 10 seconden
              </small>
            </div>
            <div class="pe-field">
              <label>
                <input type="checkbox" id="pe-reset-progress" name="resetProgress">
                Start opnieuw (negeer vorige voortgang)
              </label>
              <small class="pe-text-muted">Aangevinkt: begin vanaf URL #1. Uitgevinkt: hervat waar je gebleven was</small>
            </div>
          </div>
          <div class="pe-card__footer">
            <button type="submit" class="pe-button pe-button--primary" id="pe-sitemap-save">Instellingen opslaan</button>
            <button type="button" class="pe-button pe-button--secondary" id="pe-sitemap-import">Nu importeren</button>
            <button type="button" class="pe-button pe-button--danger" id="pe-sitemap-stop" hidden>Stop import</button>
          </div>
        </form>
      </section>

      <section class="pe-card" id="pe-manual-card">
        <h2>Optie 3: Handmatig toevoegen</h2>
        <p>Voeg individuele product URLs handmatig toe.</p>
        <div id="pe-manual-status" class="pe-alert" hidden></div>
        <form id="pe-manual-form" novalidate>
          <div class="pe-field">
            <label for="pe-manual-url">Product URL</label>
            <input type="url" id="pe-manual-url" name="productUrl" placeholder="https://example.com/product/nike-air-max" required>
          </div>
          <div class="pe-field">
            <label for="pe-manual-name">Product naam (optioneel)</label>
            <input type="text" id="pe-manual-name" name="productName" placeholder="Nike Air Max 90">
            <small class="pe-text-muted">Als je dit leeg laat, wordt de naam automatisch opgehaald van de website</small>
          </div>
          <div class="pe-card__footer">
            <button type="submit" class="pe-button pe-button--primary">Product toevoegen</button>
          </div>
        </form>
      </section>
    </div>

    <section class="pe-card" id="pe-products-card">
      <h2>Producten</h2>
      <p>Overzicht van ge√Ømporteerde producten inclusief concurrentinformatie.</p>
      <div class="pe-field" style="max-width: 320px;">
        <label for="pe-product-search">Zoek op naam, EAN of merk</label>
        <input type="search" id="pe-product-search" placeholder="Bijv. ThinkPad of 8719...">
      </div>
      <div id="pe-products-status" class="pe-alert" hidden></div>
      <div class="pe-table-wrapper" aria-live="polite">
        <table class="pe-table">
          <thead>
            <tr>
              <th style="width: 80px;">Afbeelding</th>
              <th>Product</th>
              <th>EAN</th>
              <th>Eigen prijs</th>
              <th>Varianten</th>
              <th>Concurrenten</th>
              <th>Sync status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="pe-products-body"></tbody>
        </table>
      </div>
      <div id="pe-products-pagination" class="pe-pagination" hidden></div>
      <div id="pe-products-empty" class="pe-empty-state" hidden>
        Nog geen producten gevonden. Importeer via Channable en refresh.
      </div>
    </section>

    <section class="pe-card" id="pe-variants-card" hidden>
      <h2>Varianten voor <span id="pe-selected-variant-product-name"></span></h2>
      <div class="pe-badges" style="margin-bottom: 12px;">
        <span class="pe-badge" id="pe-selected-variant-product-sku"></span>
        <span class="pe-badge" id="pe-selected-variant-product-ean"></span>
      </div>
      <div id="pe-variants-status" class="pe-alert" hidden></div>
      <div id="pe-variants-empty" class="pe-empty-state" hidden>
        Geen varianten aangemaakt voor dit product.
      </div>
      <div class="pe-variants__list" id="pe-variants-list"></div>
      <form id="pe-variant-form" style="margin-top: 16px;" novalidate>
        <div class="pe-field-group">
          <div class="pe-field">
            <label for="pe-variant-title">Variant titel</label>
            <input type="text" id="pe-variant-title" name="variantTitle" placeholder="Rood / Large">
          </div>
        </div>
        <div class="pe-field-group">
          <div class="pe-field">
            <label for="pe-option1-name">Optie 1 naam</label>
            <input type="text" id="pe-option1-name" name="option1Name" placeholder="Kleur">
          </div>
          <div class="pe-field">
            <label for="pe-option1-value">Optie 1 waarde</label>
            <input type="text" id="pe-option1-value" name="option1Value" placeholder="Rood">
          </div>
        </div>
        <div class="pe-field-group">
          <div class="pe-field">
            <label for="pe-option2-name">Optie 2 naam (optioneel)</label>
            <input type="text" id="pe-option2-name" name="option2Name" placeholder="Maat">
          </div>
          <div class="pe-field">
            <label for="pe-option2-value">Optie 2 waarde (optioneel)</label>
            <input type="text" id="pe-option2-value" name="option2Value" placeholder="Large">
          </div>
        </div>
        <div class="pe-field-group">
          <div class="pe-field">
            <label for="pe-variant-sku">SKU (optioneel)</label>
            <input type="text" id="pe-variant-sku" name="sku" placeholder="PROD-RED-L">
          </div>
          <div class="pe-field">
            <label for="pe-variant-price">Prijs (optioneel)</label>
            <input type="number" id="pe-variant-price" name="price" step="0.01" placeholder="99.95">
          </div>
        </div>
        <button type="submit" class="pe-button pe-button--primary">Variant toevoegen</button>
      </form>
    </section>

    <section class="pe-card" id="pe-competitors-card" hidden>
      <h2>Concurrenten voor <span id="pe-selected-product-name"></span></h2>
      <div class="pe-badges" style="margin-bottom: 12px;">
        <span class="pe-badge" id="pe-selected-product-sku"></span>
        <span class="pe-badge" id="pe-selected-product-ean"></span>
        <span class="pe-badge" id="pe-selected-product-own-price"></span>
      </div>
      <div id="pe-competitors-status" class="pe-alert" hidden></div>
      <div id="pe-competitors-empty" class="pe-empty-state" hidden>
        Geen handmatige concurrenten toegevoegd voor dit product.
      </div>
      <div class="pe-competitors__list" id="pe-competitors-list"></div>
      <form id="pe-competitor-form" style="margin-top: 16px;" novalidate>
        <div class="pe-field-group">
          <div class="pe-field">
            <label for="pe-competitor-retailer">Retailer</label>
            <input type="text" id="pe-competitor-retailer" name="retailer" placeholder="coolblue">
          </div>
          <div class="pe-field" style="flex: 2 1 260px;">
            <label for="pe-competitor-url">Product URL</label>
            <input type="url" id="pe-competitor-url" name="competitorUrl" placeholder="https://www.coolblue.nl/product/...">
          </div>
        </div>
        <div class="pe-button-group">
          <button type="submit" class="pe-button pe-button--primary" data-role="competitor-submit">Concurrent toevoegen</button>
          <button type="button" class="pe-button pe-button--secondary pe-button--small" id="pe-competitor-cancel-edit" hidden>Annuleren</button>
        </div>
      </form>
    </section>
  </div>
{% else %}
  <div class="pe-card" style="max-width: 480px; margin: 48px auto; text-align: center;">
    <h2>Log eerst in</h2>
    <p>Deze dashboardpagina is alleen beschikbaar voor ingelogde PriceElephant-klanten.</p>
    <a href="/account" class="pe-button pe-button--primary" style="margin-top: 12px; display: inline-flex;">Naar login</a>
  </div>
{% endif %}

<script src="{{ 'priceelephant-dashboard.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "PriceElephant dashboard",
  "settings": [
    {
      "type": "text",
      "id": "api_base_url",
      "label": "API basis URL",
      "default": "https://web-production-2568.up.railway.app",
      "info": "Root URL van de PriceElephant backend (zonder trailing slash)."
    }
  ]
}
{% endschema %}
